<!DOCTYPE html>
<html>
  <head>
    <title>native ã®ãã®å…ˆã¸ï¼ System.currentTimeMillis() ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚ˆã†ï¼</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="https://remarkjs.com/downloads/remark-0.15.0.min.js" type="text/javascript">
    </script>
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@YujiSoftware" />
    <meta name="twitter:creator" content="@YujiSoftware" />
    <meta property="og:url" content="https://yuji.software/currentTimeMillis" />
    <meta property="og:description" content="System.java ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€currentTimeMillis() ã®å®Ÿè£…ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚public static native long currentTimeMillis();ã“ã‚Œã ã‘ã€‚ native ä¿®é£¾å­ãŒã¤ã„ã¦ãŠã‚Šã€ãã®å®Ÿè£…ã¯ Java ã§ã¯æ›¸ã‹ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šã€å®Ÿè£…ã¯ä¸æ˜â€¦â€¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ nativeã€ã¤ã¾ã‚Š JVM å†…ã«å®Ÿè£…ãŒã‚ã‚‹ã®ã§ã™ã€‚ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯ã€ã¾ãš System.currentTimeMillis() ãŒãªãœ native ã«ãªã£ã¦ã„ã‚‹ã®ã‹ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚ãã—ã¦ã€JVM å®Ÿè£…ã‚’è¿½ã„ã‹ã‘ã¦ã©ã®ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚" />
    <meta property="og:title" content="native ã®ãã®å…ˆã¸ï¼ System.currentTimeMillis() ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚ˆã†ï¼" />
    <meta property="og:image" content="https://yuji.software/currentTimeMillis/img/card.png" />
    <style type="text/css">
    @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
    @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap');

    @page {
      size: 1210px 681px;
      margin: 0
    }
    @media print{
      .remark-slide-scaler{
        width: 100% !important;
        height: 100% !important;
        transform: scale(1) !important;
        top: 0 !important;
        left:0 !important;
      }
    }

    body { 
      font-family: 'Noto Sans JP", sans-serif';
    }
    a {
      color: rgb(0, 0, 238);
    }
    .remark-slide-scaler{
      overflow: hidden;
    }
    .remark-code {
      border: 5px silver double;
      border-radius: 15px;
      font-size: 32px; /* 18px */
      margin: 0 -10px;
      background-color: #F2F2F2 !important;
    }
    .remark-code, .remark-inline-code {
      font-family: "Source Code Pro", monospace;
      font-optical-sizing: auto;
      font-weight: 600;
      font-style: normal;
    }
    .remark-inline-code {
      /* font-style: italic; */
      text-decoration: underline dotted;
      color: #006;
    }

    .remark-slide-content {
      font-size: 38px; /* 20px */
      padding: 0.5em 2em 0em 2em;
    }
    .remark-slide-content > * {
      margin: 0.25em 0;
    }
    .remark-slide-number {
      display: none; /* ãƒšãƒ¼ã‚¸ç•ªå· */
    }
    .remark-slide-content h1 {
      font-size:58px; /* 55px */
    }
    .remark-slide-content h2 {
      font-size:50px; /* 45px */
    }
    .remark-slide-content h3 {
      font-size:40px; /* 35px */
    }
    .remark-slide-content .highlight {
      color: darkred;
      font-weight: bold;
    }

    .underline {
      text-decoration: underline;
    }

    .dotted .remark-code {
      border: 3px black dotted;
    }
    
    .move {
        animation: anim 0.5s ease-out;
    }
    @keyframes anim {
        0% {
            transform: translateX(300px);
        }
        100% {
            transform: translateX(0px);
        }
    }

    table{
      border-collapse: collapse;
      width: 100%;
      text-align: center;
    }
    thead > tr {
      background-color: #222;
      color: white;
    }
    td, th {
      border: 2px solid #555;
      padding: 0 0.5em;
    }

    table.bitmap tr td {
      border: 1px solid #555;
      line-height: 1.3
    }

    table.bitmap tr td:nth-child(1) {
      font-size: 32px;
      border: none;
    }

    table.bitmap tr td:nth-child(n+1) {
      font-size: 34px;
      padding: 0px 4px;
      width: 100%;
    }

    table.bitmap tr td:nth-child(4n+1) {
      border-right: 3px double black;
    }

    table.bitmap tr td.cyan {
      background-color: paleturquoise;
    }
    table.bitmap tr td.pink {
      background-color: pink;
    }
    table.bitmap tr td.yellow {
      background-color: khaki;
    }
    table.bitmap tr td.orange {
      background-color: orange ;
    }
    table.bitmap tr td.green {
      background-color: palegreen;
    }

    hr {
      border: 0;
      border-bottom: 3px dashed #444;
    }

    div.note {
      position: relative;
      padding: 0.1em 0.5em;
      border: 3px solid #22ac38;
      border-radius: 0 10px 10px 10px;
      background: #e3f5d8;
      margin-top: 72px;
      font-size: 32px;
    }
    div.note > p:first-child {
      position: absolute;
      top: -88px;
      left: -3px;
      height: 54px;
      padding: 0 1em;
      color: #fff;
      border-radius: 10px 10px 0 0;
      background: #22ac38;
      font-weight: bold;
    }
    div.note > :nth-child(n + 2) {
      margin: 0.5em auto;
    }

    div.memo {
      position: relative;
      padding: 0.1em 0.5em;
      border: 3px solid rgba(13,110,253,1);
      border-radius: 0 10px 10px 10px;
      background: rgba(218, 232, 253, 1);
      margin-top: 72px;
      font-size: 32px;
    }
    div.memo > p:first-child {
      position: absolute;
      top: -88px;
      left: -3px;
      height: 54px;
      padding: 0 1em;
      color: #fff;
      border-radius: 10px 10px 0 0;
      background: rgba(13,110,253,1);
      font-weight: bold;
    }
    div.memo > :nth-child(n + 2) {
      margin: 0.5em auto;
    }

    span.remark {
      font-size: 32px;
      color: #444;
    }

    span.img {
      display: block;
      text-align: center;
    }
    span.array img {
      height: 250px;
    }

    .flex {
      display: flex;
    }
    .flex > * {
      flex: 1;
    }
    .flex > p {
      margin: 0 0;
    }
    .flex > ul {
      margin: 0.25em 0;
    }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# native ã®ãã®å…ˆã¸ï¼
## System.currentTimeMillis() ã®
## å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚ˆã†ï¼

&nbsp;  
<img src="img/photo.jpg" width="150px;" style="border-radius: 50%; vertical-align: middle;">

@YujiSoftware

---

# ç›®æ¬¡

.note[
è³‡æ–™ã®URL

https://yuji.software/currentTimeMillis/
]

---

# æ³¨æ„ï¼šå®Ÿè£…ä¾å­˜

* æœ¬æ—¥ã®è§£èª¬ã¯ã€**Java 25** ã® **OpenJDK å®Ÿè£…**ã«åŸºã¥ã
  * VM ã«ã‚ˆã£ã¦å®Ÿè£…ãŒç•°ãªã‚‹ï¼ˆOpenJ9 ãªã©ï¼‰
  * ä»Šå¾Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§ã€å®Ÿè£…ãŒå¤‰ã‚ã‚‹ã“ã¨ãŒã‚ã‚‹
* ã‚ãã¾ã§**ç¾æ™‚ç‚¹ã§ã®å®Ÿè£…ã§ã‚ã‚‹**ã¨ã„ã†ç‚¹ã«æ³¨æ„

---

# System.currentTimeMillis() ã¨ã¯ï¼Ÿ

* **ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰**
* æˆ»ã‚Šå€¤ã¯ã€1970å¹´1æœˆ1æ—¥ 0æ™‚0åˆ†0ç§’(UTC)ã‹ã‚‰ã®çµŒéãƒŸãƒªç§’ï¼ˆ[UNIX time](https://ja.wikipedia.org/wiki/UNIX%E6%99%82%E9%96%93)ï¼‰
  * long å‹ãªã®ã§ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ï¼ˆ[2038å¹´å•é¡Œ](https://ja.wikipedia.org/wiki/2038%E5%B9%B4%E5%95%8F%E9%A1%8C)ï¼‰ã®å¿ƒé…ã¯ãªã„
* Java 1.0 ã‹ã‚‰å­˜åœ¨ã™ã‚‹

.note[
NOTE

Java 8 ä»¥é™ã§ã¯ã€ã‚ˆã‚Šä¾¿åˆ©ãª [Insntat ã‚¯ãƒ©ã‚¹](https://docs.oracle.com/javase/jp/24/docs/api/java.base/java/time/Instant.html)ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
]

---

# System.currentTimeMillis() ã®ã‚³ãƒ¼ãƒ‰

```java
@IntrinsicCandidate
public static native long currentTimeMillis();
```

* ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã®ã¿
  * native ä¿®é£¾å­ãŒã‚ã‚‹ â†’ **Cè¨€èªã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹**

.memo[
MEMO

`@IntrinsicCandidate` ã«ã¤ã„ã¦ã¯å¾Œã»ã©è§£èª¬
]

---

# native ã¨ã¯ï¼Ÿ

* TODO

---

class: center, middle

# native ã®å…ˆã¸è¡Œã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼

---

# native ã®ã‚³ãƒ¼ãƒ‰ã¯ã©ã“ã«ã‚ã‚‹ï¼Ÿ (1)

* OpenJDK ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã©ã“ã‹ã«ã‚ã‚‹ã¯ãš
* GitHub ä¸Šã§æ¤œç´¢ã—ã¦ã¿ã‚ˆã†ï¼  
  https://github.com/openjdk/jdk/

```
repo:openjdk/jdk currentTimeMillis
```

--
â†’ 1,100 ä»¶ãƒ’ãƒƒãƒˆ orz

---

# native ã®ã‚³ãƒ¼ãƒ‰ã¯ã©ã“ã«ã‚ã‚‹ï¼Ÿ (2)

* java ã®ã‚³ãƒ¼ãƒ‰ã‚’é™¤å¤–ã—ã¦ã¿ã‚‹

```
repo:openjdk/jdk currentTimeMillis -language:java
```

â†’ 27ä»¶ãƒ’ãƒƒãƒˆï¼

---

# System.c ã«ã‚ã£ãŸ

* `src/java.base/share/native/libjava/System.c` ãŒãƒ’ãƒƒãƒˆ
* `methods` ã¨è¨€ã†é…åˆ—ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
* ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã„ã„ã€ã‚³ãƒ¼ãƒ‰ã¨ã„ã„ã€ã“ã‚Œã£ã½ã„

```cpp
static JNINativeMethod methods[] = {
  {"currentTimeMillis", "()J",
        (void *)&JVM_CurrentTimeMillis},
// ç•¥
```

* ã“ã®é…åˆ—ã‚’ã©ã“ã§ä½¿ã£ã¦ã„ã‚‹ï¼Ÿ

---

# methods é…åˆ—ã¯ã©ã“ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ï¼Ÿ

* é–¢æ•°ã®å¼•æ•° `methods` é…åˆ—ã‚’æ¸¡ã—ã¦ã„ã‚‹
  * RegisterNatives ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¡ã‚½ãƒƒãƒ‰ã®ç™»éŒ²ã‚’ã™ã‚‹é–¢æ•°

```cpp
JNIEXPORT void JNICALL
Java_java_lang_System_registerNatives(JNIEnv *env, jclass cls)
{
    (*env)->RegisterNatives(env, cls,
        methods, sizeof(methods)/sizeof(methods[0]));
}
```

* Java_java_ â€¦ ã¨è¨€ã†ã“ã®é–¢æ•°ã¯ã©ã“ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼Ÿ
  * JNIEXPORT ã¨ã„ã†ã“ã¨ã¯ã€Java ã‹ã‚‰ï¼Ÿ

---

# System.java ã®å®Ÿè£…

* System ã‚¯ãƒ©ã‚¹ã« registerNatives ãŒã‚ã‚‹
* ã“ã‚Œã‚’ static ã‚¤ãƒ‹ã‚·ãƒ£ãƒ©ã‚¤ã‚¶ãƒ¼ã§å‘¼ã³å‡ºã—ã¦ã„ã‚‹

```java
private static native void registerNatives();

static {
    registerNatives();
}
````

---

# ã“ã“ã¾ã§ã®ã¾ã¨ã‚

1. åˆæœŸåŒ–
  1. System ã‚¯ãƒ©ã‚¹ã®ãƒ­ãƒ¼ãƒ‰ã« static ã‚¤ãƒ‹ã‚·ãƒ£ãƒ©ã‚¤ã‚¶ãƒ¼ãŒå‘¼ã°ã‚Œã‚‹
  2. System.registerNatives() ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹
  3. JNI çµŒç”±ã§ C ã® ã€œ_registerNatives é–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹
  4. RegisterNatives é–¢æ•°ã§ currentTimeMillis ã«å¯¾ã— JVM_CurrentTimeMillis ãŒç™»éŒ²ã•ã‚Œã‚‹
2. å®Ÿè¡Œ
  1. System.currentTimeMillis() ã‚’å‘¼ã¶
  2. JNI çµŒç”±ã§ JVM_CurrentTimeMillis() é–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹

---

# JVM_CurrentTimeMillis ã®å®Ÿè£…

```c
JVM_LEAF(jlong, JVM_CurrentTimeMillis(
                    JNIEnv *env, jclass ignored))
  return os::javaTimeMillis();
JVM_END
```

* JVM_LEAF ã¯ãƒã‚¯ãƒ­
  * Safepoint ä¸å¯ãƒ»ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ãªã„ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã—ãªã„**é–¢æ•°ã‚’å®šç¾©ã™ã‚‹**
* å‡¦ç†æ¦‚è¦
  * **ç’°å¢ƒä¾å­˜ã®é–¢æ•° `javaTimeMillis()` ã«æŠ•ã’ã‚‹ã ã‘**

---

# javaTimeMillis ã¯ã©ã“ã«ï¼Ÿ

* hotspot ã®ä¸‹ã«ã‚ã‚‹
  * ğŸ“‚**src/hotspot**
      * ğŸ“**share**: ãƒ˜ãƒƒãƒ€å®šç¾©ã‚„å…±é€šã®å®Ÿè£…
      * ğŸ“**cpu**: CPUä¾å­˜ï¼ˆx86_64, ARMãªã©ï¼‰ã®å®Ÿè£…
      * ğŸ“**os**: OSä¾å­˜ï¼ˆWindows, Linux ãªã©ï¼‰ã®å®Ÿè£…
      * ğŸ“**os_cpu**: OSÃ—CPUä¾å­˜ï¼ˆlinux_x86 ãªã©ï¼‰ã®å®Ÿè£…  
      &nbsp
* `javaTimeMillis()` ã®å®Ÿè£…ã¯** os ã®ä¸­ã«ã‚ã‚‹**

---

# os ã®æ§‹é€ 

* aix / bsd / linux / posix / windows ã«åˆ†ã‹ã‚Œã¦ã„ã‚‹
* å®Ÿè£…éšå±¤
  * POSIX
      * AIX ï¼ˆIBMã®å•†ç”¨UNIXï¼‰
      * BSD UNIXï¼ˆOpenBSD, macOS ãªã©ï¼‰
      * Linuxï¼ˆUbuntu, RedHat Linux ãªã©ï¼‰
  * Windwos

---

# é€Ÿåº¦å·®

* ã“ã®æœ€é©åŒ–ã¯ `-XX:+UnlockDiagnosticVMOptions -XX:DisableIntrinsic=_currentTimeMillis` ã§ç„¡åŠ¹åŒ–ã§ãã‚‹

```sh
java -XX:+UnlockDiagnosticVMOptions -XX:+LogCompilation -XX:+UnlockDiagnosticVMOptions -XX:DisableIntrinsic=_currentTimeMillis -cp classes SimpleInliningTest
```

</textarea>
<script type="text/javascript">
  var slideshow = remark.create({
    highlightLines: true,
    highlightStyle: "googlecode",
    ratio: '16:9'
  });
</script>
</body>
</html>